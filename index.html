<!DOCTYPE html>
<html>
	<head>
		<title>Professional Development Opportunities for Educators</title>
		
		<meta charset="utf-8" />

		<style type="text/css">
		
			body, input { 
				font-family: 'Verdana'; 
				font-size: 12px;
				margin: 0;
				line-height: 130%;
				}
				
			h1 {
				font-size: 1.25em;
				font-weight: bold;
				margin: .75em;
				padding-bottom: 1em;
				margin-top: 3em;
			}

			main {
				max-width: 85em;
				margin: 2em;
				margin-left: auto;
				margin-right: auto;
			}
			
			.container {
				max-width: 85em;
				margin-left: auto;
				margin-right: auto;
				padding-left: 1em;
			}
			
			header {
				padding: 1em;
				background: #006400;
				padding-top: 1em;
			}
			
			header img {
				max-width: 70em;
			}
			
			h2 {
				font-size: 1em;
				margin: 2em 1em 1em 1em;
				text-transform: uppercase;
				letter-spacing: .05em;
				font-weight: bold;
			}
		
			.date { 
				}
				
			.name { 
				font-weight: bold 
				}
				
			.org { 
				color: #999; 
				margin-bottom: 1em; 
				margin-top: .5em; 
				}
				
			.more-info {
				margin-top: .5em;
			}

			td, th {
				vertical-align: top;
				padding: 1em;
				margin: 0;
				border-collapse: collapse;
				border-bottom: #ccc 1px solid;
				position: relative;
			}
				
			th { 
				border-bottom: #000 1px solid; 
				text-align: left; 
				font-weight: bold;
			}
			
			#date-header, #location-header, #category-header {
				width: 10em;
			}	 
			
			a { 
				text-decoration: none; 
				color: #006400;
				}
				
			a.category {
				background: #006400;
				font-size: 75%;
				color: #fff;
				padding: .2em .4em ;
				margin: .2em;
				text-transform: uppercase;
				letter-spacing: .05em;
				display: block;
			}
			
			a.category:hover {
				background: #000;
			}
				
			.description {
				display: none;
			}
			
			#categories {
				column-count: 4;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			
			.meta {
				padding: 2em;
				margin: 1em;
				background: #efefef;
			}
			
			#categories li {
				padding: .1em 0;
				margin: 0;
			}
			
			#categories a {
				color: #006400;
			}

			
			#categories a:hover {
				color: #000;
			}
			
			.arrow {
				font-size: 80%;
				color: #ccc;
				text-align: right;
				position: absolute;
				bottom: 1em;
				padding: 0 .2em;
				right: 0;
				margin-top: -1em;
				cursor: pointer;
			}
			
			#searchterm {
			    margin-top: 1em;
			}

		</style>
	
        <!-- actually not using jquery at the moment -->
        <!--
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        -->
  
        <!-- tabletop converts a google sheet to javascript data -->
    	<script type="text/javascript" src="tabletop-master/src/tabletop.js"></script>

        <script type="text/javascript">
        
            // MISC FUNCTIONS
            
            // look at the URL string for a specific variable and return the result
            function getQueryVariable(variable)
            {
                   var query = window.location.search.substring(1);
                   var vars = query.split("&");
                   for (var i=0;i<vars.length;i++) {
                           var pair = vars[i].split("=");
                           if(pair[0] == variable){return pair[1];}
                   }
                   return(false);
            }
    
            // convert from plain text to URL variable format
            // right now that just means no spaces
            function encode(s) {
                s = s.replace(' ', '_');
            return s;
            }

            // convert back from URL variable to plain text
            function decode(s) {
                s = s.replace('_', ' ');
            return s;
            }
        
            // show/hide description by toggling display of element following the one that is clicked
            function toggle(sender) {
            
                var nextElement = sender.nextSibling;
                if ( nextElement.style.display == 'block' ) {
                    nextElement.style.display = 'none';
                    sender.innerHTML = 'more ▼';
                } else {
                    nextElement.style.display = 'block';
                    sender.innerHTML = 'less ▲';
                    }
            }
    
            // seems like an overly complicated way to add URL variables to the existing query string
            // using this so that a <th> link can sort columns without canceling the existing query
            // grabbed this from stack exchange
            function setParam(name, value) {
                var l = window.location;

                /* build params */
                var params = {};		
                var x = /(?:\??)([^=&?]+)=?([^&?]*)/g;		  
                var s = l.search;
                for(var r = x.exec(s); r; r = x.exec(s))
                {
                    r[1] = decodeURIComponent(r[1]);
                    if (!r[2]) r[2] = '%%';
                    params[r[1]] = r[2];
                }

                /* set param */
                params[name] = encodeURIComponent(value);

                /* build search */
                var search = [];
                for(var i in params)
                {
                    var p = encodeURIComponent(i);
                    var v = params[i];
                    if (v != '%%') p += '=' + v;
                    search.push(p);
                }
                search = search.join('&');

                /* execute search */
                l.search = search;
            }
            
            function searchFor(userInput, string) {
                var matchString = userInput.toLowerCase();
                if (string.toLowerCase().indexOf(matchString) != -1) {
                    return true;
                } else {
                    return false;
                    }
            }
    

    
            // SPREADSHEET PROCESSING
        
            window.onload = function() { init() };

            var public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/1XVO1smiI3iOoLJt1nPkmnxqWb2Zi4okiDTtghdBfUcQ/pubhtml';

            function init() {
                
                // get orderby and reverse queries for table ordering
                var orderby = getQueryVariable('orderby');
                if (! orderby) {
                    orderby = 'Name';
                }

                var reverse = getQueryVariable('reverse');
                if (! reverse) {
                    reverse = false;
                } else {
                    reverse = true;
                }

                // query the spreadsheet, and call showInfo() on callback
                Tabletop.init( { key: public_spreadsheet_url,
                                 callback: showInfo,
                                 simpleSheet: true,
                                 orderby: orderby,
                                 reverse: reverse } );
          }


          function showInfo(data) {
            // this is where the magic happens
            
            // data comes through as a simple array since simpleSheet is turned on
        
            // get category URL variable
            var categoryQuery = getQueryVariable('category');
            var searchQuery = getQueryVariable('search');
            
            // set the subtitle
            if (categoryQuery) {
                categoryQuery = decode(categoryQuery);
                document.getElementById("subtitle").innerHTML = categoryQuery;
            } else if (searchQuery) {
                searchQuery = decode(searchQuery);
                document.getElementById("subtitle").innerHTML = 'Results for "' + searchQuery + '"';
                document.getElementById("searchterm").value = searchQuery;
            } else {
                document.getElementById("subtitle").innerHTML = 'All Entries';
            }
            
            // set the table headers
            
            /* var results = '<table><tr><th id="categories-header">Categories</th><th id="name-header"><a href="javascript:setParam(\'orderby\', \'Name\');">Name</a></th><th id="date-header"><a href="javascript:setParam(\'orderby\', \'Date\');">Date</th><th id="location-header"><a href="javascript:setParam(\'orderby\', \'Location\');">Location</a></th>'; */
        
            // populate the results variable, which is the HTML code for our table
            var results = '<table><tr><th id="categories-header">Categories</th><th id="name-header">Name</th><th id="date-header">Date</th><th id="location-header">Location</th>';

            // keep a running array of all categories, which we will stick at the top of the page
            var allCategories = [];
            
            // loop through each row in the spreadsheet
            for (i = 0; i < data.length; i++) {
            
                // we will display this row unless this variable is negated
                var display = true;
            
                // get the data we want to show
                
                // if there is a link include it in the name
                if ( data[i].URL ) {
                    var name = '<a href="' +data[i].URL + '">' + data[i].Name + '</a>';
                } else {
                    var name = data[i].Name
                    }
                    
                // get the org
                var org = data[i].Organization;
            
                // process the categories
                // the categories are stored as a comma delimited list
            
                // split the raw categories into an array
                var categoriesRaw = data[i].Category;
                var categoryList = categoriesRaw.split(", ");
                categoryList.sort()
                
                // if a category query exists and ours doesn't match, don't show it
                if ( categoryQuery && categoryList.indexOf(categoryQuery) == -1 ) {
                    display = false;
                }

                // loop through the categories and build a sequence 
                // of links to display, rather than the raw list
                var categories = ' ';
                for (ci = 0; ci < categoryList.length; ci++) {
                    if (categoryList[ci]) {
                        categories += '<a href="?category=' + encodeURIComponent(categoryList[ci]) + '" class="category">' + categoryList[ci] + '</a> ';
                        }
                    if ( categoryList[ci] && allCategories.indexOf(categoryList[ci]) == -1 ) {
                        allCategories.push(categoryList[ci]);
                    }
                }
                
                
                if (searchQuery != false && searchQuery != 'false') {
                    console.log(searchQuery);
                    if (  searchFor(searchQuery, data[i].Name) == false && searchFor(searchQuery, data[i].Location) == false && searchFor(searchQuery, data[i].Organization) == false && searchFor(searchQuery, data[i].Description) == false && searchFor(searchQuery, data[i].Date) == false ) {
                        display = false;
                    }
                }
                
        
                // the time has come
                // add the HTML of the table row
                // I've broken this apart for easier edibility and readability
                if ( display ) {        
                    results +=	'<tr>'
                    results += '<td class="categories">' + categories +	 '</td>'
                    results += '<td><span class="name">' + name + '</span>';
                    results += '<div class="accordion">';
                    results += '<div class="org">' + org + '</div>';
                    results += '<div class="arrow" onClick="toggle(this);">more ▼</div>'
                    results += '<div class="description">' + data[i].Description + '</div>';
                    results += '</div></td>';
                    results += '<td class="date">' + data[i].Date + '</td>';
                    results += '<td class="location">' + data[i].Location + '</td>';
                    results +=	'</tr>';
                }
            }
            // lay the results in the HTML
            results += '</table>';
            document.getElementById("returns").innerHTML = results;
        
            // now display all categories in a list
            allCategories.sort()
            var categoryRes = '<li><a href="?"><strong>All Entries</strong></a></li>';
            for (i = 0; i < allCategories.length; i++) {
                categoryRes += '<li><a href="?category=' + encode(allCategories[i]) + '">' + allCategories[i] + '</a></li>';
            }
            // and set that in the HTML
            document.getElementById("categories").innerHTML = categoryRes;

        }

          /*document.write("The published spreadsheet is located at <a target='_new' href='" + public_spreadsheet_url + "'>" + public_spreadsheet_url + "</a>");		*/
        </script>
	</head>
	
	<!-- because everything happens in javascript our body is painfully simple -->
    <body>
        <header>
            <div class="container">
                <img src="images/rio-logo-white.svg" />
            </div>
        </header>
        <main>
            <h1><a href="index.html">Professional Development Opportunities for Educators</a></h1>
            
            <div class="meta">
                <ul id="categories"></ul>
            
                <form name="searchform" action="index.html" method="get"> 
                    <strong>Search:</strong>&nbsp;&nbsp;&nbsp;<input type="text" size="30" name="search" id="searchterm" />
                    <input type="submit" value="Search" style="display:none" />
                </form>
            </div>
            
            <h2 id="subtitle"></h2>
            <p id="returns"></p>
        </main>
        <footer>
        </footer>
    
    
        <script>
            // searchbox
            
            var input = document.getElementById('searchterm');
            function submitSearch() {
                if (input.value) {
                    setParam('search', input.value);
                    } else {
                    setParam('search', false);
                    }
            };
    

        </script>
    
    </body>
</html>
